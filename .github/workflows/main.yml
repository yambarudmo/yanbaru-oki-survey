name: Create Daily CSV from Spreadsheet

# GASからのHTTPリクエスト(repository_dispatch)をトリガーにする
on:
  repository_dispatch:
    types: [spreadsheet-data]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. リポジトリをチェックアウト（コードを読み込む）
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # シークレットに保存したトークンを使用する
          token: ${{ secrets.GH_TOKEN }}

      # 2. 保存先パスを準備し、CSVファイルをダウンロード
      - name: Create Daily CSV
        run: |
          # 保存先パスを変数に格納 (例: "data" や "" )
          TARGET_DIR="${{ github.event.client_payload.target_folder }}"
          
          # フォルダ名が空（ルート）でない場合、ディレクトリを作成
          if [[ -n "$TARGET_DIR" ]]; then
            mkdir -p "$TARGET_DIR"
            # 保存パスを "folder/file.csv" に設定
            # GITHUB_ENV に保存し、後続のステップでパスを使えるようにする
            echo "SAVE_PATH=$TARGET_DIR/${{ github.event.client_payload.filename }}" >> $GITHUB_ENV
            echo "TARGET_DIR_PATH=$TARGET_DIR" >> $GITHUB_ENV
          else
            # 保存パスを "file.csv" (ルート) に設定
            echo "SAVE_PATH=${{ github.event.client_payload.filename }}" >> $GITHUB_ENV
            echo "TARGET_DIR_PATH=." >> $GITHUB_ENV # ルートディレクトリ
          fi
          
          # $SAVE_PATH にファイルをダウンロード
          curl -L "${{ github.event.client_payload.download_url }}" -o "${{ env.SAVE_PATH }}"

      # 3. all.csv に全CSVを結合する
      - name: Combine all CSVs into all.csv
        run: |
          # 前のステップで設定したパス変数を読み込む
          TARGET_DIR="${{ env.TARGET_DIR_PATH }}"
          
          # 結合後のall.csvのパスを設定
          ALL_CSV_PATH="$TARGET_DIR/all.csv"
          
          # 検索対象のパスを設定
          if [[ "$TARGET_DIR" == "." ]]; then
            CSV_FILES_PATH="*.csv"
          else
            CSV_FILES_PATH="$TARGET_DIR/*.csv"
          fi

          echo "Combining CSVs into $ALL_CSV_PATH"
          echo "Searching in $CSV_FILES_PATH"
          
          # find: all.csv自身が処理対象に含まれないようにする
          find "$TARGET_DIR" -maxdepth 1 -type f -name "*.csv" -not -name "all.csv" -print0 | sort -z | \
            xargs -0 awk 'FNR > 1 || NR == 1' > "$ALL_CSV_PATH"
          
          # 結合結果が空でないか確認
          if [ ! -s "$ALL_CSV_PATH" ]; then
            echo "Warning: all.csv is empty or not created. Skipping commit of all.csv."
            # all.csvが空の場合は、コミット対象から外す
            rm -f "$ALL_CSV_PATH"
          fi

      # 4. 変更内容をコミット＆プッシュ
      - name: Commit & Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 前のステップで設定したパス変数を読み込む
          SAVE_PATH="${{ env.SAVE_PATH }}"
          TARGET_DIR_PATH="${{ env.TARGET_DIR_PATH }}"
          
          # all.csvのパスを設定
          ALL_CSV_PATH="$TARGET_DIR_PATH/all.csv"
          
          # 日次ファイルとall.csvの両方をコミット対象に追加
          git add "$SAVE_PATH"
          
          # all.csv が存在する場合のみコミット対象に追加
          if [ -f "$ALL_CSV_PATH" ]; then
            git add "$ALL_CSV_PATH"
          fi
          
          # 変更があった場合のみコミットを実行
          git diff --staged --quiet || git commit -m "daily data update: ${{ github.event.client_payload.filename }}"
          
          git push
